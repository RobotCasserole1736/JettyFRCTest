<!DOCTYPE html>

<html>
<title>Casserole Driver Data View</title>

<head>
  <link rel="stylesheet" href="main.css">
</head>

<body>

<h1>FRC 1736 Driver View</h1>
<hr>
<div/>
<div id="id01">COM Status: Socket Not Open</div>
<br>

<div id="display_objs"></div>
<br>


<div id="webcams"></div>
<br>


<!-- Common navigation bar -->
<hr>
<div style="background-color:#ce7777">
<p>
<a href="index.html">Home</a>
        
<a href="presentState.html">State Data</a>
        
<a href="calibration.html">Calibration</a>
        
<a href="driverView.html">Driver View</a>
</p>
</div>
<!-- END Common navigation bar -->



<script>
var dataSocket = new WebSocket("ws://127.0.0.1:5805/driverviewstream")
var numTransmissions = 0;
var display_objs = [];


//Class for a dial

var casseroleDial = function(elementID_in, min_in, max_in, min_acceptable_in, max_acceptable_in, step_in, name_in) {
    this.min = min_in;
    this.max = max_in;
    this.min_acceptable = min_acceptable_in;
    this.max_acceptable = max_acceptable_in;
    this.step = step_in;
    this.name = name_in;
    this.value = min_in;
    this.elementID = elementID_in;
    
    this.handcolor = "#333";
    this.bgcolor = "white";
    this.init();

}

casseroleDial.prototype.init = function(){
    this.canvas = document.getElementById(this.elementID);
    this.ctx = this.canvas.getContext("2d");
    this.radius = this.canvas.height / 2;
    this.ctx.translate(this.radius, this.radius);
    this.radius = this.radius * 0.90;
    this.drawFullDial();
}

casseroleDial.prototype.convValToAngle = function(num_in){
    return ((num_in-this.min)/(this.max-this.min)) * (1.5*Math.PI)  + 1.25*Math.PI;
}

casseroleDial.prototype.setValue = function(new_value){
    
    //draw-over background This resets to a blank dial.
    this.drawFace();
    
    this.value = new_value;
    this.drawHand();
    this.drawValue();
    this.drawNumbers(); //Just in case the hand goes over the numbers
    this.drawName();
}

casseroleDial.prototype.drawFullDial = function() {
    //draw constant parts of the dial
    this.drawFace();
    this.drawNumbers();
    this.drawName();
    
    
    //draw the variable parts of the dial
    this.drawHand();
    this.drawValue();
}

casseroleDial.prototype.drawFace = function() {
    var grad;
    
    min_acc_ang = this.convValToAngle(this.min_acceptable)-(0.5*Math.PI);
    max_acc_ang = this.convValToAngle(this.max_acceptable)-(0.5*Math.PI);
    

    //min to min acceptable
    this.ctx.beginPath();
    this.ctx.moveTo(0,0);
    this.ctx.arc(0, 0, this.radius, 0.75*Math.PI, min_acc_ang);
    grad1 = this.ctx.createRadialGradient(0,0,this.radius*0.95, 0,0,this.radius*1.05);
    grad1.addColorStop(0, this.handcolor);
    grad1.addColorStop(0.5, "red");
    grad1.addColorStop(1, this.handcolor);
    this.ctx.strokeStyle = grad1;
    this.ctx.lineWidth = this.radius*0.1;
    this.ctx.stroke();
    
    //max acceptable to max 
    this.ctx.beginPath();
    this.ctx.moveTo(0,0);
    this.ctx.arc(0, 0, this.radius, max_acc_ang, 2.25*Math.PI);
    grad3 = this.ctx.createRadialGradient(0,0,this.radius*0.95, 0,0,this.radius*1.05);
    grad3.addColorStop(0, this.handcolor);
    grad3.addColorStop(0.5, "red");
    grad3.addColorStop(1, this.handcolor);
    this.ctx.strokeStyle = grad3;
    this.ctx.lineWidth = this.radius*0.1;
    this.ctx.stroke();
    
    //min acceptable to max acceptable
    this.ctx.beginPath();
    this.ctx.moveTo(0,0);
    this.ctx.arc(0, 0, this.radius, min_acc_ang, max_acc_ang);
    grad2 = this.ctx.createRadialGradient(0,0,this.radius*0.95, 0,0,this.radius*1.05);
    grad2.addColorStop(0, this.handcolor);
    grad2.addColorStop(0.5, "green");
    grad2.addColorStop(1, this.handcolor);
    this.ctx.strokeStyle = grad2;
    this.ctx.lineWidth = this.radius*0.1;
    this.ctx.stroke();

    //White background
    this.ctx.beginPath();
    this.ctx.moveTo(0,0);
    this.ctx.arc(0, 0, this.radius*0.94, 0.0*Math.PI, 2*Math.PI);
    this.ctx.fillStyle = this.bgcolor;
    this.ctx.fill();
    
}

casseroleDial.prototype.drawNumbers = function() {
    var ang;
    var num;
    this.ctx.font = "bold " + this.radius*0.15 + "px arial";
    this.ctx.textBaseline="middle";
    this.ctx.textAlign="center";
    this.ctx.fillStyle="black";
    this.ctx.beginPath();
    this.ctx.moveTo(0,0);
    for(num= this.min; num <= this.max; num+=this.step){
        ang = this.convValToAngle(num);
        this.ctx.rotate(ang);
        this.ctx.translate(0, -this.radius*0.82);
        this.ctx.rotate(-ang);
        this.ctx.fillText(num.toString(), 0, 0);
        this.ctx.rotate(ang);
        this.ctx.translate(0, this.radius*0.82);
        this.ctx.rotate(-ang);
    }
}

casseroleDial.prototype.drawName = function() {
    this.ctx.rect(-this.radius*0.9, this.radius*0.7, this.radius*0.9*2, this.radius*0.3 );
    this.ctx.fillStyle="#cccccc";
    this.ctx.fill();
    this.ctx.translate(0, this.radius*0.85);
    this.ctx.font=this.radius*0.18 + "px arial";
    this.ctx.fillStyle="#EE0000";
    this.ctx.fillText(this.name, 0, 0);
    this.ctx.translate(0, -this.radius*0.85);

} 

casseroleDial.prototype.drawValue = function() {
    this.ctx.translate(0, this.radius*0.4);
    this.ctx.font="bold " + this.radius*0.20 + "px arial";
    this.ctx.fillStyle="#008877";
    this.ctx.fillText(this.value.toString(), 0, 0);
    this.ctx.translate(0, -this.radius*0.4);

} 

casseroleDial.prototype.drawHand = function() {
    var ang = this.convValToAngle(this.value);
    this.ctx.strokeStyle=this.handcolor;
    this.ctx.beginPath();
    this.ctx.lineWidth = this.radius*0.08;
    this.ctx.lineCap = "round";
    this.ctx.moveTo(0,0);
    this.ctx.rotate(ang);
    this.ctx.lineTo(0, -this.radius*0.7);
    this.ctx.stroke();
    this.ctx.rotate(-ang);
    
    this.ctx.beginPath();
    this.ctx.arc(0, 0, this.radius*0.1, 0, 2*Math.PI);
    this.ctx.fillStyle = this.handcolor;
    this.ctx.fill();
}

//END Dial Class


//START String Box Display class
var casseroleStringBox = function(elementID_in, name_in) {

    //initial input values
    this.name = name_in;
    this.value = "N/A"; //init to something meaningful
    this.elementID = elementID_in;
    
    //Initialize data
    this.init();
    
    //Do initial draw
    this.drawName();
    this.drawValBox();
    this.drawVal();

}

casseroleStringBox.prototype.init = function(){
    this.canvas = document.getElementById(this.elementID);
    this.ctx = this.canvas.getContext("2d");
    
    //Appearance tune params
    this.valueBoxX = this.canvas.width*0.025;  
    this.valueBoxY = this.canvas.height*0.1;  
    this.valueBoxWidth  = this.canvas.width  * 0.95;  
    this.valueBoxHeight = this.canvas.height * 0.3;  
    this.valueTextY = this.valueBoxY + (this.valueBoxHeight*0.75);
	this.valueTextX = this.valueBoxX*2;
    
    this.nameBoxX = this.canvas.width*0.025;  
    this.nameBoxY = this.canvas.height* 0.650;  
    this.nameBoxWidth  = this.canvas.width  * 0.95;  
    this.nameBoxHeight = this.canvas.height * 0.3;  
    this.nameTextY = this.nameBoxY + (this.nameBoxHeight*0.75);
	this.nameTextX = this.nameBoxX*2;
        
    this.textcolor = "#333";
    this.bgcolor = "white";
    
}

casseroleStringBox.prototype.drawName = function(){
    this.ctx.fillStyle=this.bgcolor;
    this.ctx.fillRect(this.nameBoxX, this.nameBoxY, this.nameBoxWidth, this.nameBoxHeight );
    //this.ctx.fill();
    this.ctx.font="bold " + this.nameBoxHeight*0.40 + "px arial";
    this.ctx.fillStyle=this.textcolor;
    this.ctx.fillText(this.name.toString(), this.nameTextX, this.nameTextY);

}

casseroleStringBox.prototype.drawValBox = function(){
    this.ctx.fillStyle=this.bgcolor;
    this.ctx.fillRect(this.valueBoxX, this.valueBoxY, this.valueBoxWidth, this.valueBoxHeight );
    
    //this.ctx.fill();
    
}

casseroleStringBox.prototype.drawVal = function(){
    this.ctx.font="bold " + this.valueBoxHeight*0.40 + "px arial";
    this.ctx.fillStyle=this.textcolor;
    this.ctx.fillText(this.value.toString(), this.valueTextX, this.valueTextY);
}

casseroleStringBox.prototype.setValue = function(new_value){
    this.value = new_value;
    this.drawValBox(); //draw over the existing value
    this.drawVal(); //draw new value

}
//END String Display class



//Data socket handlers
dataSocket.onopen = function (event) {
  document.getElementById("id01").innerHTML = "COM Status: Socket Open";
};

dataSocket.onerror = function (error) {
  document.getElementById("id01").innerHTML = "COM Status: Error with socket";
};

dataSocket.onmessage = function (event) {
  var arr = JSON.parse(event.data);
  var dataElementCounter = 0;
  
  if(arr.step == "initConfig"){
    //initial setup of the things on the page
    dialCanvasTexts = "";
    webcamTexts = "";
    
    //Part 1 - HTML Setup
    dataElementCounter = 0
    for(i = 0; i < arr.obj_array.length; i++){
        if(arr.obj_array[i].type == "dial"){
            dialCanvasTexts += "<canvas id=\"obj"+ (dataElementCounter) +"\" width=\"200\" height=\"200\" style=\"background-color:#333\"></canvas>"
            document.getElementById("display_objs").innerHTML = dialCanvasTexts;
            dataElementCounter++;
        } else if(arr.obj_array[i].type == "stringbox"){
            dialCanvasTexts += "<canvas id=\"obj"+ (dataElementCounter) +"\" width=\"200\" height=\"200\" style=\"background-color:#333\"></canvas>"
            document.getElementById("display_objs").innerHTML = dialCanvasTexts;
            dataElementCounter++;
        } else if(arr.obj_array[i].type == "webcam"){
            webcamTexts += "<img src=\""+arr.obj_array[i].url+"\" style=\"width:300px;height:300px;\"/>"    
        }
    }
    
    //Part 2 - init the data elements
    dataElementCounter = 0
    for(i = 0; i < arr.obj_array.length; i++){
        if(arr.obj_array[i].type == "dial"){
            display_objs.push(new casseroleDial("obj"+(dataElementCounter), arr.obj_array[i].min, arr.obj_array[i].max, arr.obj_array[i].min_acceptable, arr.obj_array[i].max_acceptable, arr.obj_array[i].step, arr.obj_array[i].name));
            dataElementCounter++;
        } else if(arr.obj_array[i].type == "stringbox") {
			display_objs.push(new casseroleStringBox("obj"+(dataElementCounter), arr.obj_array[i].name));
            dataElementCounter++;
		}
    }
    document.getElementById("webcams").innerHTML = webcamTexts;

    
  } else if(arr.step == "valUpdate"){
    dataElementCounter = 0;
    for(i = 0; i < arr.obj_array.length; i++){
        display_objs[dataElementCounter].setValue(arr.obj_array[i].value);
        dataElementCounter++;
    }
  }
  //ignore other messages
  
  
};




//Main Execution

</script>

</body>
</html>

